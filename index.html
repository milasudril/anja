<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Anja user's guide</title>
<meta name="author" content="Torbjörn Rathsman">
<meta name="description" content="Anja is a sampler designed for live sound effect playback. Anja makes it possible to assign sound effects to the keys of the computer keyboard. Anja also features a channel mixer with 16 channels making it possible to fade a group of sound effects together, as well as MIDI capabilities for remote control. The backend of Anja is JACK, the low-latency audio server.">
<meta name="keywords" content="LivePerformance, JACK, Audio, Player, Recorder, Midi, Music, sound">
<link rel="stylesheet" href="format.css" type="text/css">
<link rel="stylesheet" href="color.css" type="text/css">
</head>
<body>
<h1>Anja user's guide</h1><sub-title>version 
1.9-beta.18-1-53-gd6bb722</sub-title>
	<p class="titlepage">Torbjörn Rathsman</p><div class="titlepic">
<picture><source srcset="logo_3.png" media="(max-width:128px)"><source srcset="logo_2.png" media="(max-width:256px)"><source srcset="logo_1.png" media="(max-width:512px)"><source srcset="logo.png" media="(min-width:512px)"><img src="logo_1.png" alt="Title picture"></picture>
</div><p style="text-indent:0px;text-align:right; font-weight:bold"><a href="anja-usersguide.pdf" rel="alternate">Printer-friendly version</a></p><div class="abstract"><p>Anja is a sampler designed for live sound effect playback. Anja makes it possible to assign sound effects to the keys of the computer keyboard. Anja also features a channel mixer with 16 channels making it possible to fade a group of sound effects together, as well as MIDI capabilities for remote control. The backend of Anja is JACK, the low-latency audio server.</p>
</div><h2 id="ack">Acknowledgements</h2><p>Anja would not have been possible without these people:</p><ul><li>Erik de Castro Lopo—for libsamplerate and libsndfile</li>
<li>Jason Evans—for the jemalloc library</li>
<li>Melissa O'Neill—for the PCG32 random number generator</li>
<li>Paul Davis et.al.—for JACK</li>
<li>Stefan Buller—for valuable feedback on the user interface</li>
<li>The GTK+ team—for the UI toolkit</li></ul><p>The author, 2017</p><nav id="toc">
<h2>Contents</h2>
<ol><li><a href="#ack"><span class="content">Acknowledgements</span></a></li><li><a href="#legalbrief"><span class="content">Legal information</span></a></li><li><a href="#notations"><span class="content">Notations</span></a></li><li><a href="#intro"><span class="fill">1</span> <span class="content">Introduction</span></a><ol><li><a href="#requirements"><span class="fill">1.1</span> <span class="content">System requirements</span></a></li><li><a href="#comparison"><span class="fill">1.2</span> <span class="content">Anja compared to other software</span></a></li></ol></li><li><a href="#install"><span class="fill">2</span> <span class="content">Installing Anja</span></a><ol><li><a href="#installlinux"><span class="fill">2.1</span> <span class="content">Installing on a GNU/Linux system</span></a></li><li><a href="#compile"><span class="fill">2.2</span> <span class="content">Compiling Anja</span></a></li></ol></li><li><a href="#using"><span class="fill">3</span> <span class="content">Using Anja</span></a><ol><li><a href="#statusarea"><span class="fill">3.1</span> <span class="content">The status area</span></a></li><li><a href="#addfx"><span class="fill">3.2</span> <span class="content">Loading a waveform</span></a></li><li><a href="#play"><span class="fill">3.3</span> <span class="content">Playing waveforms</span></a><ol><li><a href="#engstatus"><span class="fill">3.3.1</span> <span class="content">Controlling and manipulating engine status</span></a></li><li><a href="#connections"><span class="fill">3.3.2</span> <span class="content">Connecting Anja to system playback</span></a></li><li><a href="#keybstatus"><span class="fill">3.3.3</span> <span class="content">Activating the keyboard</span></a></li></ol></li><li><a href="#rec"><span class="fill">3.4</span> <span class="content">Capturing waveforms</span></a></li><li><a href="#waveformprop"><span class="fill">3.5</span> <span class="content">Configuring waveform playback</span></a><ol><li><a href="#wavesource"><span class="fill">3.5.1</span> <span class="content">Source file selection</span></a></li><li><a href="#description"><span class="fill">3.5.2</span> <span class="content">Waveform description</span></a></li><li><a href="#wavecolor"><span class="fill">3.5.3</span> <span class="content">Waveform color</span></a></li><li><a href="#pbchannel"><span class="fill">3.5.4</span> <span class="content">Playback channel</span></a></li><li><a href="#pbgain"><span class="fill">3.5.5</span> <span class="content">Playback gain</span></a></li><li><a href="#pbgainrandom"><span class="fill">3.5.6</span> <span class="content">Playback gain randomization</span></a></li><li><a href="#pboptions"><span class="fill">3.5.7</span> <span class="content">Controlling playback behavior</span></a></li><li><a href="#rangeadjust"><span class="fill">3.5.8</span> <span class="content">Adjusting playback or loop range</span></a></li></ol></li><li><a href="#chmixer"><span class="fill">3.6</span> <span class="content">Configuring playback channels</span></a></li><li><a href="#multichannel"><span class="fill">3.7</span> <span class="content">Multi-channel output</span></a></li><li><a href="#midi"><span class="fill">3.8</span> <span class="content">Using MIDI</span></a></li><li><a href="#sessprops"><span class="fill">3.9</span> <span class="content">Modifying session properties</span></a></li></ol></li><li><a href="#chstatus"><span class="fill">A</span> <span class="content">Port status indicators</span></a></li><li><a href="#fileformats"><span class="fill">B</span> <span class="content">Supported file formats</span></a></li><li><a href="#keybindings"><span class="fill">C</span> <span class="content">Key bindings</span></a></li><li><a href="#signalflow"><span class="fill">D</span> <span class="content">Signal flow</span></a></li><li><a href="#midiref"><span class="fill">E</span> <span class="content">MIDI message processing</span></a></li><li><a href="#cmdline"><span class="fill">F</span> <span class="content">Command line options</span></a><ol><li><a href="#cmdline8"><span class="fill">F.1</span> <span class="content">Program information</span></a></li><li><a href="#cmdline12"><span class="fill">F.2</span> <span class="content">Appearance</span></a></li><li><a href="#cmdline16"><span class="fill">F.3</span> <span class="content">Session loading or control</span></a></li></ol></li><li><a href="#sessfile"><span class="fill">G</span> <span class="content">Session file format</span></a></li><li><a href="#deps"><span class="fill">H</span> <span class="content">Dependencies</span></a><ol><li><a href="#libs"><span class="fill">H.1</span> <span class="content">Libraries</span></a></li><li><a href="#tools"><span class="fill">H.2</span> <span class="content">Tools</span></a></li><li><a href="#resources"><span class="fill">H.3</span> <span class="content">Packages and resources</span></a></li></ol></li><li><a href="#script"><span class="fill">I</span> <span class="content">Commands accepted in scripts</span></a></li><li><a href="#srcview"><span class="fill">J</span> <span class="content">Source code overview</span></a><ol><li><a href="#modintract"><span class="fill">J.1</span> <span class="content">Component interaction</span></a></li><li><a href="#uiframework"><span class="fill">J.2</span> <span class="content">The design of the UI component</span></a></li></ol></ol>
</nav><h2 id="legalbrief">Legal information</h2><p>Anja is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.</p><p>Anja is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</p><p>You should have received a copy of the GNU General Public License along with this program. If not, see <a href="https://www.gnu.org/licenses/" target="blank">https://www.gnu.org/licenses/</a></p>

	<h2 id="notations">Notations</h2><p>The following table shows examples of notations used within this manual, or within Anja itself.</p>
	<table>
<tr class="colheaders"><td>Symbol</td><td>Meaning</td></tr>
<tr><td><img src="message_info.svg" alt="message_info.svg"></td><td>The surrounding box may contain useful tips or shortcuts</td></tr>
<tr><td><img src="message_warning.svg" alt="message_warning.svg"></td><td>The surrounding box contains information that will save you trouble</td></tr>
<tr><td><img src="message_usererror.svg" alt="message_usererror.svg"></td><td>You have done something in an incorrect way. The surrounding box contains information about how you should fix it.</td></tr>
<tr><td><img src="message_error.svg" alt="message_error.svg"></td><td>The desired action failed. The surrounding box contains information about what went wrong.</td></tr>
<tr class="hline"><td></td><td></td></tr><tr><td><kbd>Key</kbd></td><td>A key on the computer keyboard</td></tr>
<tr><td><ui-button>Button</ui-button></td><td>A button in the user interface</td></tr>
<tr><td><ui-formfield>Formfield</ui-formfield></td><td>An input field within the user interface</td></tr>
<tr><td><code>#</code>&nbsp;(U+0023)</td><td>A symbol with its Unicode® codepoint in hexadecimal notation</td></tr>
</table>
<h2 id="intro"><span class="fill">1</span> Introduction</h2><p><strong>Anja</strong> is a sample player designed for live sound effect playback. Anja makes it possible to assign sound effects to the keys typing keys of the computer keyboard. To make it easier to find sound effects, each sound effect can have a description and a color, that shows up on Anja's virtual computer keyboard.</p>

	<p>Anja also features a channel mixer with 16 channels. All sound effects are routed through one of these channels. The channel mixer makes it possible to fade a group of sound effects together. As with sound effects, each channel has a color and a description. In addition to color, description and channel gain, each channel also has an adjustable fade time, that is used to automatically fade the channel.</p>

	<p>The backend of Anja is JACK, the low-latency audio server&#160;<cite><a href="#jack">[1]</a></cite>. This makes it possible to connect Anja to other JACK clients enabling the creation of more complex signal flows.</p>

	<p>The session file format of Anja described in more detail in <a href="#sessfile">Appendix G</a> is in a formalized text format, optimized for human readability. The syntax of the session files has taken inspiration from formats such as Markdown&#160;<cite><a href="#markdown">[2]</a></cite> and is very similar to the syntax used in the “Doom template file”&#160;<cite><a href="#doomwiki">[3]</a></cite>. Therefore, session files can be easily edited by hand in a text editor, at the cost of somewhat larger session files.</p>


	<h3 id="requirements"><span class="fill">1.1</span> System requirements</h3><p>To run Anja, a working installation of JACK is required. Moreover, Anja requires <code>libsndfile</code>&#160;<cite><a href="#libsndfile">[4]</a></cite>, <code>libsamplerate</code>&#160;<cite><a href="#libsamplerate">[5]</a></cite> and <code>GTK+</code> version 3&#160;<cite><a href="#gtk">[6]</a></cite>, together with <code>gtksourceview</code> version 3&#160;<cite><a href="#gtksrcview">[7]</a></cite>. A complete list of dependencies are found in <a href="#deps">Appendix H</a>.</p>

	<p>Anja currently only builds on x86-64, and has been tested on a Prescott 2m processor (a late Pentium® 4 with long mode and HyperThreading), Core i5 IvyBridge, and Celeron® N3050. If possible, parts of the code can execute faster if Anja is compiled for an AVX capable CPU. By default, two versions of Anja are compiled, one with AVX enabled, and one without (see <a href="#compile">Section 2.2</a>), and a wrapper script is used to select the appropriate version for the current machine.</p>

	<p>Since Anja completely loads all sound files referenced from a session file, it may consume some RAM. At 48&#160;kHz, the RAM usage is 11&#160;MiB/min of sound. The minimum screen resolution for running Anja is 1024&#160;px × 768&#160;px.</p>
	
	<p>For Anja to be fully usable, the mouse should have a wheel. Moreover, it is preferable to use Anja with a MIDI keyboard with configurable knobs. Otherwise is good to have a keyboard with a high rollover count i.e. it should be possible to press many keys simultaneously.</p>


	<h3 id="comparison"><span class="fill">1.2</span> Anja compared to other software</h3><p>There are other sample players that also may be used with JACK. One such program is Hydrogen&#160;<cite><a href="#hydrogen">[8]</a></cite>. Compared to Hydrogen, Anja lacks a sequencer. However, in Hydrogen, waveforms need to be assigned in a particular order, and Hydrogen does not feature an on-screen keyboard.</p>

	<p>Other features in Anja is event-triggered auto-fade (see <a href="#chmixer">Section 3.6</a>), and also an exposed <em>kill all</em> feature (see <a href="#play">Section 3.3</a>). It also features reverse playback, and the possibility to do shorter live recordings to any given slot, which can be played back immediately  (see <a href="#rec">Section 3.4</a>).</p>

	<h2 id="install"><span class="fill">2</span> Installing Anja</h2><p>Before Anja can be used, the program needs to be installed. This chapter goes through the installation procedure.</p>

	<h3 id="installlinux"><span class="fill">2.1</span> Installing on a GNU/Linux system</h3><p>On GNU/Linux, the recommended way of installing Anja is to install it from the software repository. Ubuntu users can use the following PPA:</p>

<pre><code class="ppa">milasudril/anja</code></pre>

	<p>If there is no package available, download the source package&#160;<cite><a href="#anjasrc">[9]</a></cite>, and compile it as according to the instructions in <a href="#compile">Section 2.2</a>.</p>

	<h3 id="compile"><span class="fill">2.2</span> Compiling Anja</h3><p>Before Anja can be compiled, certain programs, and libraries are needed. These are listed in <a href="#deps">Appendix H</a>. Observe that some of the libraries may be split into a runtime package, and a development package. In this case you must install both parts of the library. On Ubuntu, these packages usually have the suffix <em>dev</em>. Anja has been written using the <code>maike</code>&#160;<cite><a href="#maike">[10]</a></cite> build tool. Therefore, this program has to be available when Anja is compiled. The <dfn>makefile</dfn> distributed with Anja, tries to detect <code>maike</code> before the compilation starts. If the <dfn>makefile</dfn> fails to detect <code>maike</code>, a package containing <code>maike</code> is downloaded from the author's GitHub repository by using <code>wget</code>&#160;<cite><a href="#wget">[11]</a></cite> and <code>jq</code>&#160;<cite><a href="#jq">[12]</a></cite>.</p>

	<div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>In addition to the general instructions given here, there are some additional information regarding build preparation in the file <code>README.md</code>.</div>
</info-content></div>

<p>As mentioned above, the Anja source package can be obtained from&#160;<cite><a href="#anjasrc">[9]</a></cite>. Following this link gives a link to a gzipped tarball. In order to extract that tarball issue the command</p>

	<pre><code class="bash">tar -xf anja-src.tar.gz</code></pre>

	<p>This will create a directory <code>anja-src</code>, in current directory. Now <code>cd</code> into that directory and run <code>make</code>:</p>

	<pre><code class="bash">cd anja-src
make</code></pre>

<div class="infobox_warning ">
<info-content>
<picture>
<source srcset="message_warning.svg">
<img src="message_warning.gif" alt="warning">
</picture>
<div>Normally, Anja is distributed with pre-rendered images. It may happen that the corresponding <code>blender</code>&#160;<cite><a href="#blender">[13]</a></cite> file has been updated and the render. In this case, it will take a much longer time than normal to compile Anja, since the images will need to be rerendered.</div>
</info-content></div>

<p>When running <code>make</code>, files are written to <code>__targets_*</code>, where  <code>*</code> represents the current profile. To satisfy all needs, four binaries are generated: {debug ∪ release}×{Prescott 2m+ ∪ Core i<var>x</var>}. After the compilation has completed, Anja can be launched directly by running the command</p>

<pre><code class="bash">./anja</code></pre>

<p>This is a shell script that selects the most appropriate binary. To make it easier to launch Anja, you can move (or copy) the script, <em>and the binaries it refers to</em> to a place mentioned in the <code>PATH</code> variable. For example, a simple install (without desktop icon and manpage) could look like</p>

<pre><code class="bash">cp ./anja ~/bin/anja
for k in __anja_*; do
	mkdir ~/bin/"$k"
	cp “$k"/anja ~/bin/"$k"
done</code></pre>

<p>In order to install everything to your home directory, you can run</p>
<pre><code class="bash">./install ~</code></pre>

	<p>If you have <code>sudo</code> permissions, you can do</p>
<pre><code class="bash">sudo make install</code></pre>
<p>This will perform a regular install, for all users. If you are using a Debian based system, you can also create a deb package, and install that. If prefer this method, run</p>

	<pre><code class="bash">make deb #Do not run this command as root
cd ..
sudo dpkg -i anja_${version}-${tag}_${architecture}.deb
</code></pre>

<p>The <code>deb</code> target will ask you some questions about dependencies, before it can continue to compile the Anja package. Notice that if all packages are installed, the script may give you some hints. Otherwise you will need to look for the corresponding package name using other resources such as searching the Internet, and install the corresponding package.</p>

	<h2 id="using"><span class="fill">3</span> Using Anja</h2><p>Starting Anja brings up a window that looks like the one presented in <a href="#anjastart">Figure 3.1</a>. The workspace consists of four main parts outlined in <a href="#anjaworkspace">Figure 3.2</a>. At the top, there is a <dfn>status area</dfn>, showing the state of Anja. Below that, there are two columns. The leftmost column contains the <dfn>action panel</dfn> with different buttons that affect Anja's current state. To the right of that, the <dfn>keyboard view</dfn> is located, and below that, there is a <dfn>settings panel</dfn>, controlling which waveforms are loaded as well as the playback of loaded waveforms.</p>

	<figure id="anjastart">
<picture><source srcset="mainwindowstart.png"><img src="mainwindowstart.png" alt="The Anja window, as shown after launching Anja without any command line arguments, and with a JACK server running."></picture><p><strong>Figure 3.1</strong>: The Anja window, as shown after launching Anja without any command line arguments, and with a JACK server running.</p></figure><figure id="anjaworkspace">
<picture><source srcset="anja_layout.svg"><img src="anja_layout.svg" alt="The different parts of the Anja workspace. At the top, there is a  status area  showing the state of Anja. To the left is the  action panel , used to control Anja&#x27;s state. To the right is the  keyboard view , which selects waveform slots and channels, and below that is the  settings panel , which is used to load waveforms and control the playback of loaded waveforms."></picture><p><strong>Figure 3.2</strong>: The different parts of the Anja workspace. At the top, there is a <dfn>status area</dfn> showing the state of Anja. To the left is the <dfn>action panel</dfn>, used to control Anja's state. To the right is the <dfn>keyboard view</dfn>, which selects waveform slots and channels, and below that is the <dfn>settings panel</dfn>, which is used to load waveforms and control the playback of loaded waveforms.</p></figure><h3 id="statusarea"><span class="fill">3.1</span> The status area</h3><p>The <dfn>status area</dfn>, shown larger in <a href="#statusareacut">Figure 3.3</a>, contains four parts as illustrated by <a href="#statusareafig">Figure 3.4</a>. The engine status and the keyboard status indicators should be self-explanatory: red <img src="led_stop.png" alt="led_stop.png"> means that it is not ready, and green <img src="led_ready.png" alt="led_ready.png"> that it is ready. A similar convention holds for the <dfn>port status area</dfn> (see <a href="#chstatus">Appendix A</a> for more details). In addition to being in the state of usable or not usable, ports are of different types: MIDI or Wave, input or output. MIDI ports have red-shaded background, while Wave ports have a blue-shaded background. Input ports are located to the left, and output ports are located to the right. Between the input and output sections, there are indicators with neutral or non-highlighted background. These represent the 16 internal Wave ports.</p>

	<figure id="statusareacut">
<picture><source srcset="statusarea.png"><img src="statusarea.png" alt="A detailed view of the  status area . The  status area  contains four panels: An engine status indicator, port status indicators, a keyboard status indicator, and a memory usage indicator."></picture><p><strong>Figure 3.3</strong>: A detailed view of the <dfn>status area</dfn>. The <dfn>status area</dfn> contains four panels: An engine status indicator, port status indicators, a keyboard status indicator, and a memory usage indicator.</p></figure><figure id="statusareafig">
<picture><source srcset="statusarea.svg"><img src="statusarea.svg" alt="Layout description of the  status area ."></picture><p><strong>Figure 3.4</strong>: Layout description of the <dfn>status area</dfn>.</p></figure><p>The memory usage indicator uses high-saturated colors for memory used by the current instance of Anja. The amount of memory used by other processes uses low-saturated colors. The level indicator is divided into two parts: RAM and swap. The RAM part is green, while the swap part is red.</p>

<div class="infobox_warning ">
<info-content>
<picture>
<source srcset="message_warning.svg">
<img src="message_warning.gif" alt="warning">
</picture>
<div>You do <em>not</em> want Anja to spill over into the swap space, since it can result in long delays between pressing triggering playback, and actual sound output. Also, it can result in sound dropout from other processes running on the same JACK server.</div>
</info-content></div>

<h3 id="addfx"><span class="fill">3.2</span> Loading a waveform</h3><p>To load a waveform, choose a slot by clicking on the corresponding key in the <dfn>keyboard view</dfn> (see <a href="#anjaworkspace">Figure 3.2</a>). It is possible to choose any typing key except system keys and the space bar. After choosing a key <kbd><var>K</var></kbd>, the corresponding key will be highlighted. Now click <ui-button>Browse…</ui-button> to the right of <ui-formfield>Source</ui-formfield> field now visible in the <dfn>settings panel</dfn> (see <a href="#anjastart">Figure 3.1</a>). This brings up a file selection dialog. It is also possible to type a filename directly in the text input field to the left of <ui-button>Browse…</ui-button>.</p>

<p>If you want to remove the waveform from the slot, without loading a new one, click on <ui-button>✗</ui-button>. If you need the same waveform again, it is possible to load the same file again, since this action does not remove the original file from disk.</p>

<div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>In case a multi-channel audio file is loaded, all channels in the input stream are mixed into one. This is because Anja uses mono waveforms. If you want to preserve individual channels, separate the channels of the input file with a tool such as <code>ffmpeg</code>&#160;<cite><a href="#ffmpeg">[14]</a></cite> and load the resulting files into different slots, mapped to different channels. Then use multi-channel output (see <a href="#multichannel">Section 3.7</a>) and trigger playback of these slots simultaneously.</div>
</info-content></div>

<div class="infobox_warning ">
<info-content>
<picture>
<source srcset="message_warning.svg">
<img src="message_warning.gif" alt="warning">
</picture>
<div>Anja does not resample any waveform during playback. Instead, it will resample waveforms that do not match the current sample rate when the engine is started. If the engine has to be restarted and the new sample rate differs (the only reason for this is that JACK itself was restarted using another sample rate), it is recommended to save the current session and reload it rather than restarting the engine. This is because multiple resample steps can result in loss of quality.
</div>
</info-content></div>

	<h3 id="play"><span class="fill">3.3</span> Playing waveforms</h3><p>Before any sound can be heard from Anja, the following conditions has to be met:</p>

	<ul><li>The <dfn>audio engine</dfn> has to be running</li>
	<li>The output of Anja has to be connected to a suitable system playback port</li>
	<li>The corresponding playback channel has to be unmuted, and have a non-zero gain. For more information, see <a href="#pbchannel">Section 3.5.4</a> and <a href="#chmixer">Section 3.6</a>.</li>
	<li>The workspace must accept keyboard input (see <a href="#keybstatus">Section 3.3.3</a>), or the MIDI input port must be connected to a MIDI event source (see <a href="#midi">Section 3.8</a>)</li></ul>

<h4 id="engstatus"><span class="fill">3.3.1</span> Controlling and manipulating engine status</h4><p>As stated in <a href="#statusarea">Section 3.1</a>, the state of the engine is showed by the leftmost panel in the <dfn>status area</dfn>. If a JACK server was already running when Anja was started, the engine should be running already. Otherwise, make sure that there is a JACK server running, and click the button <ui-button>Start engine</ui-button> in the <dfn>action panel</dfn> (see <a href="#anjaworkspace">Figure 3.2</a>). Now, there should be a new JACK client with a name that derived from the name of the current Anja session. For example, after starting the engine on the default session, there should be a JACK client called <code>New session.anja</code>.</p>

<h4 id="connections"><span class="fill">3.3.2</span> Connecting Anja to system playback</h4><p>By default, Anja has two output ports: <code>Master out</code> and <code>Audition</code>. The difference between these ports is what sound that are routed to them. <code>Master out</code> is the main output, in the sense that all playback triggered by regular key input and MIDI (see <a href="#midi">Section 3.8</a>) will be routed to this port. The <code>Audition</code> port is used for playback of the current slot (in <a href="#addfx">Section 3.2</a> the slot mapped to key <kbd><var>K</var></kbd>), triggered by hitting <kbd>Space</kbd>. To stop all non-audition playback, hit <kbd>Del</kbd>. All auditions can be stopped by hitting <kbd>Page Down</kbd>.</p>

	<div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>
	Notice that hitting <kbd>Space</kbd> will never output any sound to <code>Master out</code>. This makes it possible to pre-listen to sounds without routing them to a PA system.
	</div>
</info-content></div>

<p>The connection status of <code>Master out</code> and <code>Audition</code> is shown by the two indicators with blue-shaded background in the output section of the <dfn>port status area</dfn> (see <a href="#statusareacut">Figure 3.3</a> and <a href="#statusareafig">Figure 3.4</a>). When the engine is not running, these are black <img src="led_off.png" alt="led_off.png">. When the engine is running, a non-connected port is indicated by a yellow <img src="led_wait.png" alt="led_wait.png"> light, and a connected port is indicated by a green <img src="led_ready.png" alt="led_ready.png">. For more details about port status indicators, see <a href="#chstatus">Appendix A</a>.</p>

<figure id="portselector">
<picture><source srcset="portselector.png"><img src="portselector.png" alt="The port selection dialog. To route the signal to a port, toggle the corresponding button. The choices are confirmed by clicking  OK ."></picture><p><strong>Figure 3.5</strong>: The port selection dialog. To route the signal to a port, toggle the corresponding button. The choices are confirmed by clicking <ui-button>OK</ui-button>.</p></figure><p>A port can be connected to other ports in the system by clicking on the corresponding status indicator. This brings up a dialog box that contains toggle buttons for all available ports (see <a href="#portselector">Figure 3.5</a>). Click <ui-button>OK</ui-button> to confirm your choiee.</p>

<div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>JACK ports can be connected by using the command <code>jack_connect</code>&#160;<cite><a href="#manjack">[15]</a></cite>. To connect the mentioned ports to a pair of system playback ports. the commands would be
<pre><code class="bash">jack_connect 'New session.anja:Master out' \
    'system:playback_1'
jack_connect 'New session.anja:Audition' \
    'system:playback_2'
</code></pre>
Then, Anja will use the “Left” channel as main output, and the “Right” channel as Audition.</div>
</info-content></div>

<div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>Instead of using the command line, it is possible to use a JACK patchbay tool such as <code>Catia</code>&#160;<cite><a href="#catia">[16]</a></cite>. In <code>Catia</code> ports can be connected using “Drag and drop”.</div>
</info-content></div>


<h4 id="keybstatus"><span class="fill">3.3.3</span> Activating the keyboard</h4><p>Since the keyboard is shared between the playback triggering system and form input fields, playback can only be triggered from the keyboard when keyboard triggering is active. The <dfn>keyboard status indicator</dfn> (see <a href="#statusarea">Section 3.1</a>) is red <img src="led_stop.png" alt="led_stop.png"> when a form input field has keyboard focus, and green <img src="led_ready.png" alt="led_ready.png"> when playback triggering is active. Keyboard triggering is activated by hitting <kbd>Esc</kbd>, or by clicking anywhere on the workspace that would not capture keyboard focus.</p>

<h3 id="rec"><span class="fill">3.4</span> Capturing waveforms</h3><p>Similar to waveform playback (see <a href="#play">Section 3.3</a>), waveform capture requires that the audio engine is started. In order to capture a waveform, make sure that <code>Wave in</code> is connected to a signal source by clicking on the indicator for <code>Wave in</code>. That is, the leftmost indicator in the <dfn>port status area</dfn> (see <a href="#statusarea">Section 3.1</a>). Then press <kbd>Ctrl</kbd> and the typing area key <kbd><var>K</var></kbd> that should be used for playing the captured waveform. If the <kbd>Ctrl</kbd> is released before the typing area key, playback of the recorded waveform is triggered. If <kbd><var>K</var></kbd> is released first, the capture process is stopped.</p>

<div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>Triggering audio capture from the computer keyboard is only possible when keyboard triggering is active. When it is active, the <dfn>keyboard status indicator</dfn> is green <img src="led_ready.png" alt="led_ready.png">. Otherwise, it is red <img src="led_stop.png" alt="led_stop.png">.</div>
</info-content></div>

<div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>It is not possible to record waveforms to a slot that has been marked as read-only. See <a href="#waveformprop">Section 3.5</a> form more information.</div>
</info-content></div>

<div class="infobox_warning ">
<info-content>
<picture>
<source srcset="message_warning.svg">
<img src="message_warning.gif" alt="warning">
</picture>
<div>Captured waveforms are stored the waveform in virtual memory. This means that it is not possible to record longer waveforms. Also, trying to do so may crash Anja. See <a href="#requirements">Section 1.1</a> for information about memory requirements.</div>
</info-content></div>

<h3 id="waveformprop"><span class="fill">3.5</span> Configuring waveform playback</h3><p>The playback behaviour and other properties can be controlled through the <dfn>waveform tab</dfn> in the <dfn>settings panel</dfn> (see <a href="#anjaworkspace">Figure 3.2</a>). An enlarged view of the <dfn>waveform tab</dfn> after loading a waveform file is shown in <a href="#waveformsettings">Figure 3.6</a>. This view is activated by clicking on the corresponding key on the keyboard view.</p>

<figure id="waveformsettings">
<picture><source srcset="waveformsettings.png"><img src="waveformsettings.png" alt="An enlarged view of the  settings panel  showing the  waveform tab , after loading a waveform file. This tab contains various settings controlling playback of the selected slot."></picture><p><strong>Figure 3.6</strong>: An enlarged view of the <dfn>settings panel</dfn> showing the <dfn>waveform tab</dfn>, after loading a waveform file. This tab contains various settings controlling playback of the selected slot.</p></figure><h4 id="wavesource"><span class="fill">3.5.1</span> Source file selection</h4><p>The source file is chosen through the <ui-formfield>Source</ui-formfield> field. By clicking <ui-button>Browse…</ui-button>, a file selection dialog appears. When a different waveform file is selected Anja replaces the waveform associated with current slot, with the waveform loaded from the chosen file. For information about supported file formats, see <a href="#fileformats">Appendix B</a>.</p>

<div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>
	It is not possible to load another waveform when the current slot is in use by the engine.
</div>
</info-content></div>

<div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>
	Changing the source file on disk without clicking on the reload button <ui-button>↺</ui-button> does not affect Anja, since Anja loads a copy of the file content into memory.</div>
</info-content></div>

<div class="infobox_warning ">
<info-content>
<picture>
<source srcset="message_warning.svg">
<img src="message_warning.gif" alt="warning">
</picture>
<div>
	Avoid loading large files. Doing so, may exhaust system memory. See <a href="#requirements">Section 1.1</a> for information about memory requirements.
</div>
</info-content></div>

<h4 id="description"><span class="fill">3.5.2</span> Waveform description</h4><p>It is possible to assign an arbitrary description to the waveform slot through the <ui-formfield>Description</ui-formfield> field. The description does not affect the waveform playback, but makes it easier to find the waveform in the <dfn>Keyboard view</dfn>.</p>

<p>It may happen that the description is long. Therefore it is possible to mark a key-phrase by surrounding it with square brackets. Then, only the text within the first pair of square brackets will appear at the virtual key. If there are no square brackets within the description, the first word will be used instead.</p>

<h4 id="wavecolor"><span class="fill">3.5.3</span> Waveform color</h4><p>Like description (see <a href="#description">Section 3.5.2</a>), the <ui-formfield>Color</ui-formfield> field is only used for visual enhancements. The color is given as red-green-blue-alpha values delimited by <code>;</code>&nbsp;(U+003b), where each component is in the range [0, 1]. If the <ui-button>…</ui-button> is pressed, a color selection dialog based on the HSL color system appears.</p>

<div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>
	The idea behind color coding of waveform slots is that slots that are used in similar context can be encoded with a similar color. The color coding feature can be used to categorize different kinds of waveforms such as <var>Fx</var>  and <var>Ambient</var>.
</div>
</info-content></div>

<h4 id="pbchannel"><span class="fill">3.5.4</span> Playback channel</h4><p>The <ui-formfield>Channel</ui-formfield> field assigns a channel to the waveform slot. All sound from this slot will be routed through the selected channel.</p>

<div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>
	Channels can be used to fade multiple sound sources together. The mix of all channels can either be controlled by the internal <dfn>channel mixer</dfn> (see <a href="#chmixer">Section 3.6</a>), or by an external mixer (see <a href="#multichannel">Section 3.7</a>).
</div>
</info-content></div>

<h4 id="pbgain"><span class="fill">3.5.5</span> Playback gain</h4><p>Before the signal reaches the strip for the selected playback channel (see <a href="#pbchannel">Section 3.5.4</a>), the signal is amplified by the given playback gain. The gain can be adjusted from -72&#160;dB to 6&#160;dB.</p>

<h4 id="pbgainrandom"><span class="fill">3.5.6</span> Playback gain randomization</h4><p>In addition to deterministic playback gain adjustment, it is possible to add a non-deterministic component to the playback gain. The  parameter <ui-formfield>Gain random</ui-formfield> sets how much the random component is amplified.</p>

<div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>Depending on the state of the <ui-formfield>Set gain on loop</ui-formfield> flag (see <a href="#pboptgainrand">Section 3.5.7.4</a>), new random numbers are drawn on manual re-triggering, or for each iteration when playback loop is active. This can be useful for creating a more “living” sound.</div>
</info-content></div>

<h4 id="pboptions"><span class="fill">3.5.7</span> Controlling playback behavior</h4><p>There are different options for controlling the playback behavior. These are <dfn>Loop</dfn>, <dfn>Sustain</dfn>, <dfn>Readonly</dfn>, and <dfn>Set gain on loop</dfn>.</p>

<h5 id="pboptloop"><span class="fill">3.5.7.1</span> Loop</h5><p>When <dfn>Loop</dfn> is enabled, playback will start form the <dfn>loop begin cursor </dfn> when the playback position reaches the <dfn>loop end cursor</dfn>, if no stopping event has occurred before that happens. For more information about adjusting cursors, see <a href="#rangeadjust">Section 3.5.8</a>.</p>

<h5 id="pboptsustain"><span class="fill">3.5.7.2</span> Sustain</h5><p>The <dfn>Sustain</dfn> flag controls whether or not a key release event should also send a stop event. When the <dfn>Sustain</dfn> flag is set, a stop event is not sent, emulating the effect of a pushed sustain pedal. </p>

<h5 id="pboptreadonly"><span class="fill">3.5.7.3</span> Readonly</h5><p>The <dfn>Readonly</dfn> flag controls whether or not it is possible to overwrite a loaded waveform with captured audio (see <a href="#rec">Section 3.4</a>). Enabling <dfn>Readonly</dfn> prevents that a loaded waveform is accidentally overwritten by a record command.</p>

<h5 id="pboptgainrand"><span class="fill">3.5.7.4</span> Set gain on loop</h5><p>As mentioned in <a href="#pbgainrandom">Section 3.5.6</a>, it is possible to only randomize gain on the trig event, but it is also possible set a new gain for each iteration in a loop. When this flag is set, the latter happens.</p>

<h4 id="rangeadjust"><span class="fill">3.5.8</span> Adjusting playback or loop range</h4><p>It may happen that only a part of a loaded waveform is interesting for playback or loop. With the <dfn>trim panel</dfn> (see <a href="#trimpanel">Figure 3.7</a>), it is possible to select the part of the waveform that should be played or looped. The graph shows in dB<sub>FS</sub>, the root mean square signal power integrated over 1&#160;ms, as a function of time in seconds. On top of the function graph, there are four cursors showing playback and loop range, as well as the <dfn>auto-trigger threshold level</dfn>. In addition to the plot window, there are four input fields that can be used to set playback cursor positions by entering the corresponding time position in seconds. The leftmost input field <ui-formfield>↦</ui-formfield> sets the <em>begin</em> position. The next input field, <ui-formfield>↪</ui-formfield>, sets the <em>loop begin</em> position. The next two input fields, <ui-formfield>↩</ui-formfield> and <ui-formfield>⇥</ui-formfield>, controls <em>loop end</em> and <em>end</em> respectively. Between the <em>begin</em> part and <em>end</em> section is a toggle button that toggles reversed playback.</p>

<figure id="trimpanel">
<picture><source srcset="waveformtrim.png"><img src="waveformtrim.png" alt="The  trim panel . Together with cursor positions, the plot window shows in dB FS , the root mean square signal power integrated over  1  as a function of time in seconds. Below the plot window there are four input fields that sets the positions of the playback cursors. "></picture><p><strong>Figure 3.7</strong>: The <dfn>trim panel</dfn>. Together with cursor positions, the plot window shows in dB<sub>FS</sub>, the root mean square signal power integrated over 1&#160;ms as a function of time in seconds. Below the plot window there are four input fields that sets the positions of the playback cursors. </p></figure><div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>
Notice that when a cursor is located at the same position as another cursor, it might be obscured by the other cursor. This is why there are only three cursors visible in <a href="#trimpanel">Figure 3.7</a>.
</div>
</info-content></div>

<figure id="playseq">
<picture><source srcset="playseq.svg"><img src="playseq.svg" alt="The playback sequence. Playback starts at the  begin  cursor and passes the  loop begin  cursor. When the playback position reaches the  loop end  cursor, and loop is activated and the engine has not received a stop message, the playback will continue from  loop begin  when it reaches  loop end . Otherwise, playback continues until  end  is reached, or a stop message is received."></picture><p><strong>Figure 3.8</strong>: The playback sequence. Playback starts at the <em>begin</em> cursor and passes the <em>loop begin</em> cursor. When the playback position reaches the <em>loop end</em> cursor, and loop is activated and the engine has not received a stop message, the playback will continue from <em>loop begin</em> when it reaches <em>loop end</em>. Otherwise, playback continues until <em>end</em> is reached, or a stop message is received.</p></figure><p>Before going into the details on how to set playback and loop ranges, it is good to get an overview of the playback sequence illustrated in <a href="#playseq">Figure 3.8</a>. Playback starts at the <em>begin</em> cursor and passes the <em>loop begin</em> cursor. When the playback position reaches the <em>loop end</em> cursor, and loop is activated and the engine has not received a stop message, the playback will continue from <em>loop begin</em> when it reaches <em>loop end</em>. Otherwise, playback continues until <em>end</em> is reached, or a stop message is received.</p>

<div class="infobox_warning ">
<info-content>
<picture>
<source srcset="message_warning.svg">
<img src="message_warning.gif" alt="warning">
</picture>
<div>If the <em>loop begin</em> cursor coincides with <em>loop end</em> cursor, the loop range becomes empty and there will be no audible loop.
</div>
</info-content></div>

<h5 id="cursorpositions"><span class="fill">3.5.8.1</span> Setting cursor positions</h5><p>The primary way of setting the position of a cursor is to drag the cursor into position. The position of the <em>begin</em> is controlled by the green solid cursor and the position of the <em>loop begin</em> is controlled by the green dashed cursor. The end cursors are drawn the same way but in red instead of green.</p>

<div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>If it is hard to position a cursor sufficiently exact, try pressing <kbd>Ctrl</kbd> or <kbd>Shift</kbd> while using the mousewheel. This will zoom in or out in the <var>x</var> or <var>y</var> directions. Dragging inside the plot window, but not near a cursor, will translate the view window. Right-clicking in the plot window will reset the view to its initial state.
</div>
</info-content></div>

<p>Another way of adjusting the cursor positions is to drag the auto-triggering cursor while pressing <kbd>Shift</kbd>. This will move the <em>begin</em> and <em>end</em> cursors to the first or last position where the signal power exceeds the current threshold level. If this requires that the loop cursors to move, they will be pushed by the non-loop cursors.</p>

<div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>It is possible to use the auto-trigger threshold to set both the playback range and the loop range individually as long as the loop range is set given a higher threshold level. Since the auto-trigger only moves the <em>begin</em> and <em>end</em> cursors, but doing so may push the loop cursors to new positions, it is possible to push the loop cursors inwards to a certain position. When lowering the auto-trigger threshold, the loop cursors stays, but the other cursors move outwards.
</div>
</info-content></div>

<div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>If <kbd>Shift</kbd> is not pressed when the auto-triggering cursor is moved, no automatic adjustment is applied. This way, the auto-triggering cursor can be used as a guide for positioning the cursors manually.
</div>
</info-content></div>

<p>A third option is to enter cursors positions into the input fields below the plot window. The leftmost input field <ui-formfield>↦</ui-formfield> sets the <em>begin</em> position. The next input field, <ui-formfield>↪</ui-formfield>, sets the <em>loop begin</em> position. The next two input fields, <ui-formfield>↩</ui-formfield> and <ui-formfield>⇥</ui-formfield>, controls <em>loop end</em> and <em>end</em> respectively.</p>

<h5 id="revplayback"><span class="fill">3.5.8.2</span> Reversed playback</h5><p>Reversed playback is toggled by the middle button in the <dfn>trim panel</dfn> (see <a href="#trimpanel">Figure 3.7</a>). What it does is to swap the direction shown in <a href="#playseq">Figure 3.8</a> by reversing the list of cursor.  Another way of enabling reversed playback is to manually position the <em>end</em> cursors before the <em>begin</em> cursors. When <em>begin</em> and <em>end</em> cursors meats, the reverse toggle button changes state.</p>

<h3 id="chmixer"><span class="fill">3.6</span> Configuring playback channels</h3><p>The <dfn>Channel mixer</dfn> is shown in <a href="#channelmixerfig">Figure 3.9</a>. The <dfn>Channel mixer</dfn> controls the playback volume for the different playback channels. To the right of all channel strips, there is a master gain control, which controls the playback volume of the mixed channels. In addition to a gain control, each channel strip also contains an input field for selecting a channel color, which works similar to the color input field for waveforms (see <a href="#wavecolor">Section 3.5.3</a>), and a control for determining the duration of automatic fade-in/out operations.</p>

<figure id="channelmixerfig">
<picture><source srcset="channels.png"><img src="channels.png" alt="The  Channel mixer . Each channel strip has a label, a color, a fade time knob, and a volume slider. To the right of all strips, there is a master gain control, that affects the gain of the mix."></picture><p><strong>Figure 3.9</strong>: The <dfn>Channel mixer</dfn>. Each channel strip has a label, a color, a fade time knob, and a volume slider. To the right of all strips, there is a master gain control, that affects the gain of the mix.</p></figure><div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>
	It can be a good idea to match the channel colors in some way to the colors used for the waveform associated with the playback channel. This makes it easier to identify the playback channel for different waveform slots.
</div>
</info-content></div>

<div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>
	The knob uses an exponential mapping to increase precision for shorter time values. Also, it uses polar coordinates. If it is hard to find the right value, try to increase the distance from the cursor to the knob center when dragging the knob handle. It is also possible to enter values into the text entry field below the knob.
</div>
</info-content></div>

<p>Automatic fade-in/out is triggered by hitting <kbd>F<var>k</var></kbd> while pressing <kbd>↑</kbd>/<kbd>↓</kbd>, where <var>k</var> is the channel number. After fade-out, the channel is muted until it is unmuted or a fade-in occures. Mute and unmuting a channel is done by hitting the corresponding channel key (<kbd>F<var>k</var></kbd>) while pressing <kbd>←</kbd> or <kbd>→</kbd> respectively.</p>

<div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>
	It is only possible to access channel 1 to 12 from the PC keyboard. In order to auto-fade channel 13-16, an external MIDI controller can be used, see <a href="#midi">Section 3.8</a>.
</div>
</info-content></div>

<div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>
	Using the PC keyboard to trigger fade-in/out is only possible when keyboard input is active. See <a href="#keybstatus">Section 3.3.3</a> for more information.
</div>
</info-content></div>

<p>When a channel is muted and the engine uses single-channel output, the corresponding indicator in the <dfn>port status area</dfn> (see <a href="#statusarea">Section 3.1</a>), is red <img src="led_stop.png" alt="led_stop.png">. The same is true when the engine uses multi-channel output (see <a href="#multichannel">Section 3.7</a>). In the case the engine uses multi-channel output and the corresponding port is not connected, the muted state is indicated by a black <img src="led_off.png" alt="led_off.png"> indicator. Unmuting the channel, reverts the corresponding indicator to its original state. All possible states of the port status indicators are listed in <a href="#chstatus">Appendix A</a>.</p>


<h3 id="multichannel"><span class="fill">3.7</span> Multi-channel output</h3><p>Anja has the option to use individual channel output. This enables the use of external effect processors on the different channels. To activate this feature, check the checkbox <ui-button>Use individual ports for each channel</ui-button> in the <dfn>session tab</dfn> (see <a href="#sessprops">Section 3.9</a>), and restart the engine by clicking on <ui-button>Start engine</ui-button> in the <dfn>action panel</dfn> (see <a href="#anjaworkspace">Figure 3.2</a>). When individual ports are used for different channels, Anja creates one JACK port for each of the 16 channels in addition to <code>Master out</code> and <code>Audition</code>. These ports are connected in a similar way as described in <a href="#connections">Section 3.3.2</a>, that is by clicking on the corresponding status indicator (see <a href="#statusarea">Section 3.1</a>).</p>

<p>The signal sent to the channel-dedicated output ports are taken after the channel strip, but before the master gain adjustment. When activating multi-channel output, the port status indicators for the playback channels turns yellow <img src="led_wait.png" alt="led_wait.png"> or black <img src="led_off.png" alt="led_off.png"> (depending on mute state) since the corresponding ports are not connected to any input port. However, the signal is still being routed to <code>Master out</code>. For a complete overview of the signal flow, see <a href="#signalflow">Appendix D</a>.
</p>

<div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>With JACK, it is possible to connect multiple output ports to one input port. In this case, JACK will sum over all inputs. To reduce the signal level after summation, other JACK tools such as <code>Non Mixer</code>&#160;<cite><a href="#non">[17]</a></cite> can be used</div>
</info-content></div>

<h3 id="midi"><span class="fill">3.8</span> Using MIDI</h3><p>MIDI is a standard for communications between musical instruments, and other equipment&#160;<cite><a href="#mma">[18]</a></cite>. Through MIDI, Anja can be controlled by other MIDI enabled devices or software applications. To make it work, connect the <code>MIDI in</code> port to any MIDI output port such as <code>midi_capture_1</code>, and Anja will respond to external MIDI messages. Implementation details of different MIDI messages can be found in <a href="#midiref">Appendix E</a>.</p>

<p>Anja can also be used to control other MIDI enabled devices or software applications. To let Anja do so, connect <code>MIDI out</code> to a suitable MIDI input port on the device or software application you want to control. Anja posts the messages generated by the computer keyboard to <code>MIDI out</code>. The messages generated in different situations are listed in <a href="#midiref">Appendix E</a>.</p>

<div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>As with wave ports, MIDI ports can be connected by clicking on the corresponding status indicator (see <a href="#connections">Section 3.3.2</a>). See <a href="#statusarea">Section 3.1</a> for information about how to identify ports in the <dfn>status area</dfn>.</div>
</info-content></div>

<div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>
MIDI messages for playing notes are always tagged with a MIDI channel number. In Anja, the MIDI channels are the same as the playback channels (see <a href="#pbchannel">Section 3.5.4</a> and <a href="#chmixer">Section 3.6</a>). Thus, there are two sources for the channel number: the MIDI message itself, and the channel number of the slot referred to by the MIDI message. To resolve this, there is an option <ui-button>Allow external MIDI sources to set playback channel</ui-button> in the <dfn>session tab</dfn> (see <a href="#sessprops">Section 3.9</a>).
</div>
</info-content></div>

<div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>
When <code>MIDI out</code> is connected to a MIDI input port, Anja resets the state of the receiver, and updates its channel volumes. This means that if the owner of the input port plays any note, there will be no more audio output from that device or software application until the next “note on” message comes.
</div>
</info-content></div>

<h3 id="sessprops"><span class="fill">3.9</span> Modifying session properties</h3><p>The <dfn>session tab</dfn>, shown in <a href="#sesspropspanel">Figure 3.10</a>, contains some session-wide settings. The <ui-formfield>Title</ui-formfield> is used to identify the session in the JACK patchbay. It is also possible give the session a <ui-formfield>Description</ui-formfield> that may contain other relevant information, such as a longer description, or legal information.</p>

<figure id="sesspropspanel">
<picture><source srcset="session.png"><img src="session.png" alt="The  session tab . From this tab, it is possible to give the session a title and a description, as well as enabling multi-channel output (see  multichannel ). "></picture><p><strong>Figure 3.10</strong>: The <dfn>session tab</dfn>. From this tab, it is possible to give the session a title and a description, as well as enabling multi-channel output (see <a href="#multichannel">Section 3.7</a>). </p></figure><div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>
The session also has a set of properties that affects certain behaviour of Anja. For more information, see <a href="#multichannel">Section 3.7</a> and <a href="#midi">Section 3.8</a>.
</div>
</info-content></div>

<div class="infobox_info ">
<info-content>
<picture>
<source srcset="message_info.svg">
<img src="message_info.gif" alt="info">
</picture>
<div>
	Both toggling multi-channel output and setting a new title requires the engine to be restarted.
</div>
</info-content></div>

	<h2>References</h2><p class="bibitem" id="jack"> [1] 
		<a href="http://jackaudio.org" target="blank">http://jackaudio.org</a></p><p class="bibitem" id="markdown"> [2] 
		<a href="https://daringfireball.net/projects/markdown" target="blank">https://daringfireball.net/projects/markdown</a></p><p class="bibitem" id="doomwiki"> [3] 
		<a href="http://doom.wikia.com/wiki/Doom_file_template" target="blank">http://doom.wikia.com/wiki/Doom_file_template</a></p><p class="bibitem" id="libsndfile"> [4] 
		<a href="http://www.mega-nerd.com/libsndfile" target="blank">http://www.mega-nerd.com/libsndfile</a></p><p class="bibitem" id="libsamplerate"> [5] 
		<a href="http://www.mega-nerd.com/SRC" target="blank">http://www.mega-nerd.com/SRC</a></p><p class="bibitem" id="gtk"> [6] 
		<a href="https://www.gtk.org" target="blank">https://www.gtk.org</a></p><p class="bibitem" id="gtksrcview"> [7] 
		<a href="https://wiki.gnome.org/Projects/GtkSourceView" target="blank">https://wiki.gnome.org/Projects/GtkSourceView</a></p><p class="bibitem" id="hydrogen"> [8] 
		<a href="http://www.hydrogen-music.org/hcms" target="blank">http://www.hydrogen-music.org/hcms</a></p><p class="bibitem" id="anjasrc"> [9] 
		<a href="https://github.com/milasudril/anja/releases/latest" target="blank">https://github.com/milasudril/anja/releases/latest</a></p><p class="bibitem" id="maike"> [10] 
		<a href="https://github.com/milasudril/maike" target="blank">https://github.com/milasudril/maike</a></p><p class="bibitem" id="wget"> [11] 
		<a href="https://www.gnu.org/software/wget/" target="blank">https://www.gnu.org/software/wget/</a></p><p class="bibitem" id="jq"> [12] 
		<a href="https://stedolan.github.io/jq/" target="blank">https://stedolan.github.io/jq/</a></p><p class="bibitem" id="blender"> [13] 
		<a href="https://www.blender.org" target="blank">https://www.blender.org</a></p><p class="bibitem" id="ffmpeg"> [14] 
		<a href="https://www.ffmpeg.org" target="blank">https://www.ffmpeg.org</a></p><p class="bibitem" id="manjack"> [15] 
		<code>jack_connect</code> manual page</p><p class="bibitem" id="catia"> [16] 
		<a href="http://kxstudio.linuxaudio.org" target="blank">http://kxstudio.linuxaudio.org</a></p><p class="bibitem" id="non"> [17] 
		<a href="http://non.tuxfamily.org/wiki/Non%20Mixer" target="blank">http://non.tuxfamily.org/wiki/Non%20Mixer</a></p><p class="bibitem" id="mma"> [18] 
		<a href="http://midi.org" target="blank">http://midi.org</a></p><h2 id="chstatus"><span class="fill">A</span> Port status indicators</h2><p>This table shows all states the port status indicators can have.</p>
<table>
<tr class="colheaders"><td>Indicator</td><td>Meaning</td></tr>
<tr><td><img src="led_off.png" alt="led_off.png"></td><td>Engine is not running</td></tr>
<tr><td><img src="led_off.png" alt="led_off.png"></td><td>Channel is muted, and not connected to any port</td></tr>
<tr><td><img src="led_wait.png" alt="led_wait.png"></td><td>Channel is unmuted and not connected to any port</td></tr>
<tr><td><img src="led_stop.png" alt="led_stop.png"></td><td>Channel muted, and connected to some port</td></tr>
<tr><td><img src="led_ready.png" alt="led_ready.png"></td><td>Channel unmuted and connected to some port</td></tr>
</table>
<h2 id="fileformats"><span class="fill">B</span> Supported file formats</h2><p>Anja uses <code>libsndfile</code> in order to load waveform files. Thus the file formats supported by Anja, are the same as those supported by <code>libsndfile</code>. If <code>libsndfile</code> does not support the file format of a particular waveform file, it can probably be converted to a supported file format by using <code>ffmpeg</code>. In such case, remember that you should not transcode to a lossy format (mp3 to ogg is bad), but rather to a lossless format (mp3 to wav is good).</p>

	<h2 id="keybindings"><span class="fill">C</span> Key bindings</h2><p>These are the key bindins used in Anja. Notice that any of these except <kbd>Esc</kbd> requires that the computer keyboard is active.</p>
	<table>
<tr class="colheaders"><td>Key combination</td><td>Function</td></tr>
<tr><td><kbd>Ctrl</kbd>+<kbd><var>key</var></kbd></td><td>Record to <kbd><var>key</var></kbd></td></tr>
<tr><td><kbd>Esc</kbd></td><td>Activate the computer keyboard. Hit this key if other keys in this list have no effect.</td></tr>
<tr><td><kbd>Del</kbd></td><td>Stop all audio playback on <code>Master out</code> or channel ports</td></tr>
<tr><td><kbd><var>key</var></kbd></td><td>Start playback of the slot associated with <var>key</var></td></tr>
<tr><td><kbd>Page Down</kbd></td><td>Stop all audio playback on <code>Audition</code></td></tr>
<tr><td><kbd>Space</kbd></td><td>Start audition playback of current slot</td></tr>
<tr><td><kbd>↑</kbd> + <kbd>F<var>k</var></kbd></td><td>Fade in channel <var>k</var></td></tr>
<tr><td><kbd>↓</kbd> + <kbd>F<var>k</var></kbd></td><td>Fade out channel <var>k</var></td></tr>
<tr><td><kbd>←</kbd> + <kbd>F<var>k</var></kbd></td><td>Mute channel <var>k</var></td></tr>
<tr><td><kbd>→</kbd> + <kbd>F<var>k</var></kbd></td><td>Unmute channel <var>k</var></td></tr>
</table>
<h2 id="signalflow"><span class="fill">D</span> Signal flow</h2><p>The following graph illustrates the signal flow of Anja.</p>
<figure>
<picture><source srcset="signalflow.svg"><img src="signalflow.svg" alt="signalflow.svg"></picture></figure><h2 id="midiref"><span class="fill">E</span> MIDI message processing</h2><p>The following table lists all MIDI messages that Anja processes, and how they are processed.</p>
<table>
<tr class="colheaders"><td>Message</td><td>Control code</td><td>Anja's response</td></tr>
<tr><td>NOTE_OFF</td><td>N/A</td><td>Stop all playback that is associated with the given key</td></tr>
<tr><td>NOTE_ON</td><td>N/A</td><td>If possible, start playback using the slot given by the first data byte. If channel override is allowed (see <a href="#midi">Section 3.8</a>), the mapped waveform will be played through the channel given by the message. Otherwise, the it is played through the channel set by anja (see <a href="#pbchannel">Section 3.5.4</a>).</td></tr>
<tr><td>CONTROL_CHANGE</td><td>CHANNEL_VOLUME</td><td>Set playback channel volume. Notice that Anja assumes that the value is a linearly mapped dB value (0 corresponds to -72&#160;dB, 127 corresponds to 6&#160;dB), as opposed to General MIDI, which says that the value should be a regular gain. The reason for this implementation is to make better use of the seven bits available in a single channel volume message.</td></tr>
<tr><td> </td><td>SOUND_OFF</td><td>Stop all ongoing playback. If The last data byte is non-zero, it stops all <code>Audiotion</code> playback. Otherwise, all other playback is stopped.</td></tr>
<tr><td> </td><td>GENERAL_PURPOSE_1</td><td>Start a fade-out on the given channel. The second data byte controls the decay rate.</td></tr>
<tr><td> </td><td>GENERAL_PURPOSE_2</td><td>Start a fade-in on the given channel. The second data byte controls the decay rate.</td></tr>
<tr><td> </td><td>GENERAL_PURPOSE_3</td><td>If possible, enable recording to the slot given by the second data byte. If recording is already enabled, the last block of the current recording is discarded.</td></tr>
<tr><td> </td><td>GENERAL_PURPOSE_4</td><td>If possible, disable recording to the slot given by the second data byte</td></tr>
</table>
<h2 id="cmdline"><span class="fill">F</span> Command line options</h2><p>This is a summary of all command line options. Values inside square brackets are optional. The different argument types accepted by the different options are</p><ul>
<li class="cmdoption"><p><em>bool</em> := (<code>true</code> | <code>false</code> | <code>yes</code> | <code>no</code>)</p>

<p>can be <code>true</code>, <code>false</code>, <code>yes</code>, or <code>no</code>. <code>true</code> is equivalent to <code>yes</code> and <code>false</code> is equivalent to no. It is also possible to use a number. In this case, any non-zero value is <code>true</code> and zero is <code>false</code>.</p></li>
<li class="cmdoption"><p><em>filename in</em> := (A name of an existing file)</p>

<p>If there is no file with the given name, an error occurs.</p></li>
<li class="cmdoption"><p><em>filename out</em> := (A valid filename)</p>

<p>If a file with the same name already exists, it will be overwritten.</p></li>
<li class="cmdoption"><p><em>theme</em> := (<code>dark</code> | <code>light</code>)</p></li>
<li class="cmdoption"><p><em>window mode</em> := (<code>fullscreen</code> | <code>windowed</code>)</p></li>
</ul><h3 id="cmdline8"><span class="fill">F.1</span> Program information</h3><ul>
<li class="cmdoption"><p><code>--about</code>[=<em>filename out</em>]</p>

<p>prints an about message to <em>filename out</em>. Without argument, the data is written to standard outout.</p></li>
<li class="cmdoption"><p><code>--help</code>[=<em>filename out</em>]</p>

<p>prints all availible command line options to <em>filename out</em>. Without argument, the data is written to standard outout.</p></li>
<li class="cmdoption"><p><code>--version</code>[=<em>filename out</em>]</p>

<p>prints version information to <em>filename out</em>. Without argument, the data is written to standard outout.</p></li>
</ul><h3 id="cmdline12"><span class="fill">F.2</span> Appearance</h3><ul>
<li class="cmdoption"><p><code>--theme</code>=<em>theme</em></p>

<p>selects the UI theme. The default theme is <code>dark</code>. Notice that theme modes does not work on all GTK+3 themes. In this case, this option has no effect.</p></li>
<li class="cmdoption"><p><code>--window-mode</code>=<em>window mode</em></p>

<p>selects the window mode. The default mode is <code>windowed</code>.</p></li>
</ul><h3 id="cmdline16"><span class="fill">F.3</span> Session loading or control</h3><ul>
<li class="cmdoption"><p><code>--session</code>=<em>filename in</em></p>

<p>loads a saved session from <em>filename in</em>. Notice that this option is ignored if <code>script</code> is given.</p></li>
<li class="cmdoption"><p><code>--script</code>[=<em>filename in</em>]</p>

<p>reads and executes commands from <em>filename in</em>. Without argument, the session is read from standard input. The command stream works independently of the UI. Notice that this option overrides the <code>session</code> option.</p></li>
<li class="cmdoption"><p><code>--offline</code>=<em>bool</em></p>

<p>determines whether or not Anja should be started in offline mode. By default, Anja tries to connect to the JACK server determined by the <code>JACK_DEFAULT_SERVER</code> environment variable. This option can be used to override that behaviour.</p></li>
</ul>

<h2 id="sessfile"><span class="fill">G</span> Session file format</h2><p>Anja session files are plain text files, that contains all session properties, waveform settings, and channel settings. Session files do not contain any waveforms. Instead they refer to the file that contains the actual waveform. The idea is that the session file acts as a machine-readable <code>README</code> file, that is somehow bundled with the waveform files. Thus, the session file should be very easy to read by humans.</p>

<p>For an example of what a session file might look like, see <code>testbank/testbank.txt</code> in the source repository. The file is organized as a hierarchical key-value store. Section headers begin with a number of consecutive <code>#</code>&nbsp;(U+0023), which have to appear as the first non-whitespace character on a line. The header ends with a newline character. The section level is the same as the number of characters used to begin the header. A key begins with a <code>~</code>&nbsp;(U+007e), which similarly to the section header delimiter, has to be the first non-whitespace character on the line, and ends with <code>:</code>&nbsp;(U+003a) or a newline character. After the ending delimiter, follows the associated value. At any point, a <code>\</code>&nbsp;(U+005c) can be used if a delimiter should be processed literally.</p>

<p>In general, any character that has no particular meaning in the current context, can be used without escaping. To make it possible to write session files in a more readable way, some special rules apply to whitespaces. Whitespaces immediatly following a delimiter or another whitespace, are ignored. As mentioned above, newline characters cannot appear unescaped in keys. In values, two or more newline characters that are only separated by other whitespace characters, are collapsed into two newline characters. Unescaped single newlines are treated in the same way as any whitespace.</p>

<p>If the first key in a section is <code>Description</code>, it is possible to ommit the key, and write its value right after the section header. This makes it possible to write session files more like a regular document.</p>

<h2 id="deps"><span class="fill">H</span> Dependencies</h2><p>This chapter lists all external dependencies, as extracted by <code>maike</code>, used within the Anja project. The items listed in <a href="#libs">Section H.1</a> are also needed to run Anja. On some distributions, library packages are split into a runtime package and a development package. In this case, only the runtime package is needed to run Anja, but the development package is needed to compile Anja.</p><h3 id="libs"><span class="fill">H.1</span> Libraries</h3><p>The following list contains all libraries except for the C++ runtime library,  required by Anja.</p><ul class="deps"><li>atk-1.0</li>
<li>cairo</li>
<li>cairo-gobject</li>
<li>gdk-3</li>
<li>gdk_pixbuf-2.0</li>
<li>gio-2.0</li>
<li>glib-2.0</li>
<li>gobject-2.0</li>
<li>gtk-3</li>
<li>gtksourceview-3.0</li>
<li>jack</li>
<li>jemalloc</li>
<li>pango-1.0</li>
<li>pangocairo-1.0</li>
<li>pthread</li>
<li>samplerate</li>
<li>sndfile</li></ul><h3 id="tools"><span class="fill">H.2</span> Tools</h3><p>The following list contains all tools, required to compile Anja.</p><ul class="deps"><li>Xvfb</li>
<li>ar</li>
<li>awk</li>
<li>bash</li>
<li>blender</li>
<li>cat</li>
<li>cp</li>
<li>csplit</li>
<li>dot</li>
<li>find</li>
<li>g++</li>
<li>grep</li>
<li>import</li>
<li>inkscape</li>
<li>jackd</li>
<li>maike</li>
<li>markdown</li>
<li>octave-cli</li>
<li>pkg-config</li>
<li>python3</li>
<li>rm</li>
<li>rmdir</li>
<li>ronn</li>
<li>sed</li>
<li>sleep</li>
<li>sort</li>
<li>tail</li>
<li>tar</li>
<li>tee</li>
<li>uniq</li>
<li>xargs</li>
<li>xdotool</li>
<li>xdpyinfo</li>
<li>xelatex</li>
<li>xsltproc</li></ul><h3 id="resources"><span class="fill">H.3</span> Packages and resources</h3><p>The following list contains all external resources, required to compile Anja. This list includes static resources like fonts, and packages for scripting languages.</p><ul class="deps"><li>linux-libertine</li>
<li>numpy</li></ul>

<h2 id="script"><span class="fill">I</span> Commands accepted in scripts</h2><p>With the <code>--script</code> option (see <a href="#cmdline">Appendix F</a>), it is possible to perform some tasks when starting Anja. This option has been added to make it possible to generate relevant screenshots for this manual. This means that only features that are needed for that purpose are currently implemented. Also, the syntax may change in a future release and it is not very tolerant with respect to whitespace. Nevertheless, this appendix contains a list of all implemented commands.</p>

<ul>
<li class="cmdoption"><p><code>layout inspect</code></p>
<p>prints coordinates of bounding boxes for various parts of the GUI to standard output. The outline in <a href="#anjaworkspace">Figure 3.2</a> has been generated by using this command.</p></li>

<li class="cmdoption"><p><code>port selector open</code>,<em>port indicator index</em></p>

<p>opens the <dfn>port selector dialog</dfn> (see <a href="#portselector">Figure 3.5</a>) as if the user clicked on the port status indicator in the <dfn>status area</dfn> (see <a href="#statusarea">Section 3.1</a>), with the given index</p></li>

<li class="cmdoption"><p><code>port selector close</code></p>
<p>closes any open <dfn>port selector dialog</dfn></p></li>

<li class="cmdoption"><p><code>waveform load</code>,<em>slot</em>,<em>filename in</em></p>
<p>Loads <em>filename in</em> into <em>slot</em>, where slot is an integer in [0, 128[</p></li>

<li class="cmdoption"><p><code>session load</code>,<em>filename in</em></p>
<p>Loads the session <em>filename in</em></p></li>

<li class="cmdoption"><p><code>settings</code>,<em>tab</em></p>
<p>Reveals <em>tab</em>, where <em>tab</em> is one of <code>waveform</code>, <code>channels</code> and <code>session</code></p></li>
</ul>

<h2 id="srcview"><span class="fill">J</span> Source code overview</h2><p>The source code of Anja is divided into three major components: Engine, Session data storage, and UI. The engine is the component that communicates with JACK. The session data component is responsible for disk I/O of session and waveform files. The UI code handles the user interface. In addition to these components, there are in the repository, some more general classes, MIDI interaction helper files, resource files, test data, and also the source files for this manual. These file categories are represented by a directory, which contains all of its files.</p>

<h3 id="modintract"><span class="fill">J.1</span> Component interaction</h3><p>The component interaction is illustrated in <a href="#modinteractfig">Figure J.1</a>. It is the engine and the UI that are the “active” components. When a setting is changed, the UI will modify the corresponding field in the session data. If that change should affect another part of the UI, the UI will update the relevant parts itself. When the engine needs a waveform and its parameter values, it will fetch these from the session data component. This direct approach makes the code easier to follow and keeps the session data component clean, but requires changes at more places in the code, compared to an orthodox MVC approach, where the model updates all registered views upon a succeeded change request.</p>

<figure id="modinteractfig">
<picture><source srcset="modinteract.svg"><img src="modinteract.svg" alt="Component interaction in Anja. The engine and the UI are the active components, while the session data component acts as a passive data store."></picture><p><strong>Figure J.1</strong>: Component interaction in Anja. The engine and the UI are the active components, while the session data component acts as a passive data store.</p></figure><p>When the user triggers the engine, the UI posts a MIDI message, by calling <code>Engine::messagePost</code>, to a ringbuffer, which is read by the realtime thread in the engine. The messages are then processed by the engine. Some actions requires that the engine updates the UI. This problem is solved by another FIFO with two post methods: <code>UiContext::messagePost</code> and <code>UiContext::messagePostTry</code>. The former will block until the message can be processed, while the latter will simply fail if the message cannot be processed. Thus, from any realtime context, the latter must be used.</p>

<p>Some requests to the session data component may take a longer time. In this case it is possible to pass a progress callback object to the affected method. Typically, the callback object will be some of the UI objects, but there is no explicit association from the session data component to the UI component.</p>

<h3 id="uiframework"><span class="fill">J.2</span> The design of the UI component</h3><p>The UI component has been designed to hide as much as possible about the underlying framework, while trying to preserve the native look and feel. This means that no widget exposes the internal handle, and most of the common UI widgets, i.e. buttons, checkboxes, comboboxes, labels, sliders, and text input fields, are nothing more than thin wrappers on top of the framework. Also, the file selection dialog belongs to this category. Widgets that have a sematic difference between different platforms, are emulated using these basic widgets. As an example, listboxes are emulated using a <code>ButtonList</code>, which itself consists of a set of buttons. Some widgets such as the <code>XYPlot</code> are completely missing from common UI frameworks. In this case, they have been implemented directly at top of the framework. This is because it is hard to construct a general abstraction on top of a drawing API.</p>

<p>In addition to widgets, there are “containers”. A container is any class that implements the <code>Container</code> interface. Since some frameworks, such as the classic Windows API, is easiest to work with if the container is created before its children, and this design is more restrictive than creating the widgets before the container, Anja uses the container-first priciple. Notice that  unlike in <code>GTK+-3.0</code>, <em>containers are not widgets</em>. In fact, there is no exposed <code>Widget</code> base class, since the only polymorphic behaviour required by widgets, positioning, are handled by the framework.</p>

<p>Event handlers are registered by passing a callback object and an id, to the widget of interest. Different widget has different requirement of the callback object. More information about this topic can be found in the include file for the widget.</p>

<p>Modal dialog boxes are emulated as modeless dialogues that disables the main window. The <code>Dialog</code> is a template that owns a widget, and some buttons specified by a dialog trait. Event handlers for the buttons are handled in a similar way as for widgets. A callback object is assigned to the dialog, and when the user activates a button, the corresponding method on the callback object is invoked.</p>

</body>
</html>
